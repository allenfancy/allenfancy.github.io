---
layout: post
title: "ZooKeeper基础概念"
date: 2017-05-01
description: "ZooKeeper基础概念"
tag: zookeeper
---   

### 一、Zookeeper特性
     1.顺序一致性
          从同一个客户端发起的事务请求，最终将会严格地按照其发起的顺序被应用到Zookeeper中去
     2.原子性
          所有事务请求的处理结果在整个集群中所有机器上的应用情况是一致的，也就是说，要么整个集群所有机器都成功应用了某个事务，要么都没有应用，一定不会出现部分机器应用了该事务，而另外一部分没有应用。
     3.可靠性
          一旦服务端成功地应用了一个事务，并完成了对客户单的响应，那么该事务所引起的服务器端状态变更将会被一直保留下来，除非有另外一个事务有对其进行了变更。
     4.单一视图
          无论客户端连接的是哪个ZK服务器，其看到的服务端数据模型都是一致的
     5.实时性
          客户端最终一定能够从服务端上读取到最新的数据状态

### 二、Zookeeper的设计目标
     Zookeeper致力于一个高性能、高可用、切有严格的顺序访问控制能力的分布式协调服务。高性能使得Zookeeper能够应用于那些对系统吞吐有明确要求的大型分布式系统中，高可用使得分布式的单点问题得到了解决。严格的顺序访问控制使得客户端能够基于ZooKeeper实现一些复杂的同步原语。
     目标一：简单的数据模型
          ZooKeeper使得分布式程序能够通过一个共享的、树形结构的名字空间来进行相互协调。树型结构的名字空间是指：ZK服务器内存中的一个数据模型，其由一系列称为ZNODE的数据节点组成，总的来说，其数据模型类似于一个文件系统，而ZNode之间的层级关系，就像文件系统的目录结构一样。ZooKeeper将全部的数据存储在内存中，来实现提供服务吞吐、减少延迟的目的
     目标二：集群的构建
          Zookeeper集群通常由一组机器组成，一般为3-5台机器可以组成一个可用的ZK集群
     目标三：顺序访问
          对于来自客户端的每个更新请求，ZooKeeper都会分配一个全局唯一的递增编号，这个编号反映了所有事务操作的先后顺序，应用程序可以使用Zookeeper的这个特性来实现更高层次的同步原语。
     目标四：高性能
          ZK将全部的数据存储在内存中，并直接服务于客户端的所有非事务请求，因此它尤其适用于以读操作为主的应用场景。

### 三、ZooKeeper的基本概念
    1.集群角色
          通常在分布式系统中，构成一个集群的每一台机器都有自己的角色，最典型的集群模式就是Master/slave模式(主备模式)，将能够处理所有的写操作的机器称为Master机器，把所有通过异步复制方式获取最新数据，并提供读服务的机器称为Slave机器
          ZK中，引入了Leader、Follower和Observer三种角色。ZK集群中的所有机器通过Leader选举过程来选定一台称为LEADER的机器，LEADER服务器为客户端提供读和写服务。Follower和observer提供读服务。Follower和Observer的唯一区别在于不参加Leader的选举过程，写不参与写操作的”过半写成功”策略，因此Observer可以在不影响写性能的情况下提升集群的读性能。
    2.会话(Session)
    3.数据节点(ZNode)
        在谈及到分布式的时，节点是指组成集群的每一台机器。在ZK中，节点分为：机器节点和数据节点；数据节点是指数据模型中的数据单元，我们成为ZNode。数据模型是一棵树(ZNode Tree),由斜杠(/)进行分割的路径，就是一个ZNode，如/foo/path.每个ZNode上都会保存自己的数据内容和一部分的属性信息
        在ZK中，ZNode可以分为持久节点和临时节点俩类。临时的节点它的生命周期和客户端的会话进行绑定，一旦客户端会话失效，那么这个客户端创建的所有的临时节点都会被删除。ZK允许用户为每个节点添加一个特殊的属性：SEQUENTIAL。一旦节点被标记上这个属性，那么节点被创建的时候，ZK会自动在后面追加一个整型数字，这个整型数字是有一个父节点维护的自增的数字。
    4.版本
        ZK的每个ZNode上都会存储数据，对应于每个ZNode，ZK都会为其维护一个为Stat的数据结构，Stat中记录了这个ZNode的三个数据版本，分别为：version(当前ZNode的版本)、cversion(当前ZNode子节点的版本)和aversion(当前ZNode的ACL版本)。
     5.Watcher
          Watcher(事件监听器),是ZK非常重要的特性。ZK允许用户在指定的节点上注册一些Watcher，并且在一些特定事件触发的时候，ZK服务器会将事件通知到感兴趣的客户端上去，该机器上ZK实现分布式协调服务的重要特性。
     6.ACL
          ZooKeeper采用ACL(Access Control Lists)策略来进行权限控制，类似于UNIX文件系统的权限控制，ZK定义了如下5种权限：
          {*CREATE：创建子节点的权限}
          *READ : 获取界定啊数据和子节点列表的权限
          *WRITE：更新节点数据的权限
          {*DELETE：删除自己子节点的权限}
          *ADMIN： 设置节点ACL的权限
         注意：CREATE 和 DELETE这俩种权限都是针对子节点的权限控制。
    7.ZAB协议
          ZooKeeper Atomic Broadcast(ZAB,ZooKeeper原子消息广播协议)的协议作为其数据一致性的核心算法。
          ZAB协议是为分布式协调服务ZooKeeper专门设计的一种支持奔溃恢复的原子广播协议。它是特别为ZooKeeper设计的崩溃可恢复的原子广播算法。在ZK中主要依赖ZAB协议来实现分布式数据一致性，基于该协议，ZK实现了一种主备模式的系统架构来保持集群中个副本之间数据的一致性。
          
### 四、ZAB协议介绍：
          ZAB协议包括俩种基本的模式：崩溃恢复和消息广播。当整个服务框架在启动过着中，或是当Leader服务器出现网络中断、崩溃退出与重启等异常情况时，ZAB协议就会进入恢复模式并选举产生新的Leader服务器。当选举产生了新的Leader服务器后，同时集群中已经有过半的机器与该Leader服务器完成状体同步之后，ZAB协议就会退出恢复模式。其中所谓的装填同步是指数据同步、用来保证集群中存在过半的机器能够和Leader服务器的数据状态保持一致。
          当集群中已经有购版的Follower服务器完成了和Leader服务器的状态同步，那么整个服务器框架就可以进入消息广播模式了。
          消息广播：
          ZAB协议的消息广播过程使用的是一个原子广播协议，类似于一个二阶段提供的过程。针对客户端的事务请求，Leader服务器会为其生存对应的事务Proposal，并将其发送给集群中其余所有的机器，然后再分别收集各自的选票，最后进行事务提交。
