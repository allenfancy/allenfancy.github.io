---
layout: post
title: "redis缓存失效策略"
date: 2015-04-30
description: "redis缓存失效策略"
tag: 分布式缓存 
---   

### 一.Expirer主键失效机制：
        在Redis中，有生存期的key被称为volatile，在创建缓存时，要为给定的key设置生存期，当key过期的时候，它可能会被删除
    1.影响生存时间的一些操作
        生存时间可以通过使用DEL命令来删除整个key来移除，或者被set和Getset命令覆盖原来的数据，也就是说，修改key对value和使用另外相同的key和value来覆盖后，当前数据生存时间不同
    2.如何更新生存时间
        可以对一个已经有生存的key执行EXPIRE命令，新制定的生存时间会取代旧的生存时间。过期时间的精度已经被控制在1ms之内，主键失效的时间复杂度是O(1),EXPIRE 和TTL命令搭配使用，TTL可以查看key的生存时间设置成功返回1，不存在或者设置失败返回0

### 二.Redis提供6种数据淘汰策略：
        1.volatile-lru:从已设置过期时间的数据集(server.db[0].expires)中挑选最近最小使用的数据淘汰
        2.volatile-ttl:从已经设置过期时间的数据集 中挑选将要过期的数据淘汰
        3.volatile-random：从已设置过期的时间的数据集中任意选择淘汰的数据
        4.allkeys-lru:从数据集中挑选最近最少使用的数据淘汰
        5.allkeys-random:从数据集(server.db[i].dict)中任意选择数据淘汰    
        6.no-enviction(驱逐)：禁止驱逐数据

### 三.使用策略规则：
        1.如果数据分布呈现幂等分布，也就是一部分数据访问频率高，一部分数据访问频率低，则使用allkeys-lru
        2.如果数据呈现平等分布，也就是所有的数据访问频率都相同，则使用allkeys-random

### 四.三种数据淘汰策略：
    ttl和random比较容易，实现也会比较简单。主要是LRU最近最少使用淘汰策略，设计上会对key按失效时间排序，然后取最先失效的key进行淘汰.

### 五.Redis的主键失效机制对系统性能的影响
    Redis会定期检查设置了失效时间的主键并删除已经失效的主键，但是通过对每次处理数据库个数的限制、activeExpireCycle函数再一秒钟内执行次数的限制、分配给ActiveExpireCycle函数CPU时间的限制、继续删除主键的失效主键百分比的限制，Redis已经大大降低了主键失效机制对缓存的穿透情况
    
### 六.如何避免大量主键在同一时间失效造成数据库压力过大？
    合理设置缓存可以增加系统的健壮性，避免缓存失效造成的事故.
        1.在缓存失效后，通过加锁或者队列来控制读数据库写缓存数的线程数。比如对某一个key只允许一个线程查询数据和写缓存，其他线程等待
        2.可以通过缓存reload机制，预先去更新缓存
        3.不同的key，设置不同的过期时间，让缓存时间点尽量均匀点
        4.做二级缓存，或者双缓存策略，A1为原始缓存，A2为拷贝缓存，A1失效，可以访问A2，A1缓存失效时间设置为短期，A2设置为长期