---
layout: post
title: "Spring Cloud Eureka"
date: 2017-11-11
description: "Spring Cloud Eureka"
tag: Spring Cloud
---   


### 1. Eureka基础
    Spring Cloud Eureka是Spring Cloud Netflix 微服务套件中的一部分，他基于Netflix Eureka做了2次封装，主要负责完成微服务框架中的服务治理功能。核心内容：
        1.构建服务注册中心
        2.服务注册和服务发现
        3.Eureka的基础架构
        4.Eureka的服务治理机制
        5.Eureka的配置

    服务治理：
        服务治理可以说是微服务框架中最核心和最基础的模块，他主要用来实现各个服务实例的自动发现注册与发现。
    
    服务注册：
        在服务治理框架中，通常都会构建一个注册中心，每个服务单元向注册中心登记自己提供的服务，将主机号、版本号、通信协议等一些附加信息告知注册中心，注册中心按服务名分类组织服务清单。例如：A服务：192.168.0.100:8000和192.168.0.100:9000,B提供服务进程分别是：192.168.0.100:9000和192.168.0.100:9001和192.168.0.100:9002.当服务进程均启动，并向注册中心自己的服务之后，注册中心就会维护类似下面的清单，服务注册中心还需要以心跳的方式去检测清单中的服务是否可用，如果不可用的话，就会从清单列表剔除，达到排除故障服务的效果。
        
    服务发现：
        由于在服务治理框架下运行，服务间的服务不再通过制定具体的实例地址来实现，而是通过向服务名发起请求调用实现。所以，服务调用方在调用服务提供方法接口的时候，并不知道具体的服务实例位置。因此，调用方需要向服务注册中心咨询服务，并获取所有服务的实例清单，以实现对具体服务实例的访问。比如： C想调用A，那么C向注册中心咨询服务请求，服务注册中心就会想将服务器A的可用位置返回C，当C发起调用的时候，就会通过某种算法进行服务调用。
        
### 2.Netflix Eureka
        Spring Cloud Eureka，使用Netflix Eureka来实现服务注册与发现，它即包含了服务端组件，也包含了客户端组件，并且服务端与客户端均采用Java编写，所以Eureka主要适用于通过Java实现的分布式系统，或是与JVM兼容语言构建的系统。         但是由于Eureka服务端的服务治理机制提供了完备的RESTFUL API。所以它也支持将非Java语言构建的微服务应用纳入Eureka的服务治理体系中来。
        Eureka服务端，我们也称为服务注册中心。他同其服务注册中心一样，支持高可用配置。他依托于强一致性提供良好的服务实例可用性，可以应对多种不同的故障场景。
        如果Eureka以集群模式不是，当集群中有分片出现故障时，那么Eureka就转入自我保护模式，它允许在分布式故障期间继续提供服务的发现和注册，当故障分片恢复运行时，集群中的其他分片会他们的状态再次同步回来。
        Eureka客户端，主要处理服务的注册与发现。客户端服务通过注解和参数配置的方式，嵌入在客户端应用程序的代码中，在应用程序运行时，Eureka客户端向注册中心注册自身提供的服务并周期性地发送心跳来更新它的服务租约。

### 3.高可用注册中心
        在微服务架构这样分布式环境中个，我们需要充分考虑故障的情况，因此在生产环境中必须要对各个组件进行高可用部署，对于微服务如此，对于注册中心也是一样的。
        Eureka Server的设计，在服务治理设计中，所有的节点是服务提供方法，也是服务的消费方，服务注册中心也不例外。
        Eureka Server的高可用实际上是将自己作为服务向其他服务注册中心注册自己，这样就可以形成一个高可用的服务注册中心，以实现服务清淡的互相同步，达到高可用的效果.如果使用IP地址的形式，需要eureka.instance.prefer-ip-addres=true.

### 4.服务发现与消费
        微服务架构中的核心组件-服务注册中心(单节点和高可用模式).现在有了服务的注册中心和服务提供者，服务端点消费者是如何实现。服务消费者的任务由Ribbon完成。
        Ribbon是一个机遇HTTP和TCP的客户端负载均衡器，他可以通过客户端中配置的ribbonServerList服务列表去轮询访问以达到均衡负载的作用。
        当Ribbon和Eureka联合使用时，Ribbon的服务实例清单RibbonServerList会被DiscoveryEnableNIWSServerList重写.扩展成Eureka注册中心获取服务端礼包

### 5.Eureka详解
    Eureka 三个核心：
    
        服务注册中心：
            Eureka提供的服务端，提供服务注册与发现的功能。
            
        服务提供：
            提供服务的应用，可以是Spring-boot应用，也可以是其他技术平台且遵循Eureka通信机制的应用。
        
        服务消费者：
            消费者应用从服务注册中心获取服务列表，从而使消费者可以知道去何处调用他的服务.Ribbon实现服务端消费，Feign的消费方式

    很多的时候，客户端即使服务提供者也是服务的消费者
    
    服务治理：
        Eureka实现的服务治理体系是如何运作起来的。
            1.服务注册中心A和服务注册中心B，互为注册组成高可用集群。
            2.服务提供者启动俩个实例，一个注册到服务注册中心A，一个注册到服务注册中心B中。俩个消费者，分别只指向一个注册中心。
    
    服务提供者：
        
        1.服务注册
            在启动的时候会通过发送REST请求的方式将自己注册到Eureka Server上，同时带上自己服务的一些元数据。
            确保：eureka.client.register-with-eureka=true.默认就是true
        
        2.服务同步
            俩个服务提供者分别注册到了来个不同的服务注册中心上。他们的信息分别被俩个注册中心维护。此时，由于服务注册中心之间化为注册服务，但服务提供者发送请求到一个服务注册中心的时候，它会将该请求转发集群中其他的注册中心，从而实现注册中心之间的服务同步。
        
        3.服务续约
            在注册完成服务之后，服务提供者会维护一个心跳用来持续告诉Eureka Server。以防止Eureka Server的剔除任务将该服务实例从服务列表中排除出去。称为服务续约(renew).有以下俩个属性进行维护：
            eureka.instance.lease-renewal-interval-in-seconds=30
            eureka.instance.lease-expiration-duration-in-seconds = 90
    
    服务消费者
        
        1.获取服务    
            服务注册中心已经注册了一个服务，并且该服务有俩个实例。启动服务消费者的时候，它会发送一个REST请求给服务注册中心，来获取上面注册的服务清淡。为了考虑性能，Eureka Server会维护一份只读的服务清淡来跟会给客户端，同时该缓存会每隔30秒更新一次。获取服务是消费者的基础，所以必须保证eureka.client.fetch-registry=true.
       
        2.服务调用：
            服务消费者在获取服务清单后，通过服务名称可以获得具体提供服务的实例名称和该实例的元数据信息因为只有这些服务实例的详细信息，所以客户端可以根据需要决定具体调用哪一个实例。在RIBBON中会采用轮询的方式进行调用，从而实现客户端的负载均衡.
            对于访问实例的选择，Eureka中有Region和Zone的概念，一个Region中可以包含多个Zone，每个服务客户端需要被注册到一个Zone中，所以每个客户端对应一个Region和一个Zone。在进行服务调动的时候，优先访问同一个Zone中的服务提供方，访问不到的话，就会访问其他的Zone。
      
        3.服务下线    
            在系统运行是过程中必然会面临关闭或者重启某个实例的情况，在服务关闭期间。服务关闭操作时，会触发一个服务下线的REST请求给Eureka Server，告诉服务注册汇中心，我要下线了。告诉服务状态设置为下线(DOWN)，并把下线的事件传播出去。
    
    服务注册中心
       
        1.失效踢出
            有的时候服务实例并不一定会正常下线，可能由于内存溢出、网络故障灯原因使得服务不能正常工作，而服务注册中心并未收到服务下线的请求。为了从服务视力表中将这些无法提供服务的实例剔除，Eureka Server在启动的时候会创建一个定时任务，把没有续约的服务剔除出去。
       
        2.自我保护  
            Eureka在运行期间，会统计一个心跳连接，告诉Eureka Server自己还活着。心跳失败的比例在15分钟呢你是否低于80%,如果出现低于的情况，Eureka会将自己的当前的实例注册信息保护起来，让这些实例不会过期。使用：
            eureka.server.enable-slef-presvervation=false参数进行关闭。  

### 5.配置详解:
    Eureka客户端的配置：
        1.服务注册相关的配置信息，包括服务注册中心的地址、服务获取的时间间隔、可用区域等
        2.服务实例相关的配置信息，包括服务实例的名称、IP地址、端口号、健康检查路径等
    
    Eureka的服务端，大多数情况下，不需要修改任何参数配置信息。通过源码，org.springframework.cloud.netflix.eureka.server.EurekaServerConfigBean
 
    服务注册类配置：
        1.关于服务注册类的配置信息，可以通过org.springframework.cloud.netflix.eureka.EurekaClientConfigBean的原来查看。