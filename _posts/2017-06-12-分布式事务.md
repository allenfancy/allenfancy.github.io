---
layout: post
title: "分布式事务"
date: 2017-06-12
description: "分布式事务"
tag: 分布式
---   


### 1.分布式事务
    分布式事务服务(Distributed Transaction Service,DTS)是一个分布式事务框架，用来保障在大规模分布式环境下事务的最终一致性。DTS从架构上分为xts-client和xts-server俩部分，前者是一个嵌入客户端应用的JAR包，主要负责事务数据的写入和处理；后者是一个独立的系统，主要负责异常事务的恢复。

### 2.核心特性：
    传统关系型数据库的事务模型必须遵守ACID原则。在单数据库模式下，ACID模型能有效保障数据的完整性，但是在大规模分布式环境下，一个业务往往会跨越多个数据库，如何保证这多个数据库之间的数据一致性，需要其他行指有效的策略。在JavaEE规范使用2PC来处理跨DB环境下的事务问题。但是2PC是反可伸缩模式，也就是说，在模式处理过程中，参与者需要一直持有资源直到整个分布式事务结束。这样，当业务规模达到千万级以上时，2PC的局限性就越来越明显，系统可伸缩性会变得越差。基于此，我们采用BASE的思想实现了一套类似2PC的分布式事务方案，这就是DTS。DTS在充分保障分布式环境下高可用性、高可靠性的同时兼容数据一致性的要求，其最大特点是保证数据最终一致性。
    DTS框架有如下特点：
        最终一致：事务处理过程中，会有短暂不一致的情况，但通过恢复系统，可以让事务的数据达到最终一致的目标。
        协议简单：DTS定义了类似2PC的标准俩阶段接口，业务系统只要实现对应的接口就可以使用DTS的事务功能
     
    与RPC服务协议无关：在SOA框架下，一个或多个DB操作往往DB操作往往被包装一个个的Service，Service与Service之间通过RPC协议通信。DTS框架构建在SOA架构上，与底层协议无关
### 3.底层事务实现无关：
     DTS是一个抽象的基于Service层的概念，与底层事务实现无关，也就是说在DTS的范围内，无论是无关型数据库MySQL、Oracle，还是KV存储的MemCache,或者列存储数据库HBASE，只要将对其的操作包装成DTS的参与者，就可以接入到DTS事务范围。
     

### 4.核心概念
    在DTS内部，我们将一个分布式的关联方，分为发起方和参与者俩类：
        1.发起方：分布式事务的发起方负责启动分布式事务，触发创建响应的主事务记录。发起方是分布式事务的协调者，负责调用参与者的服务，并记录响应的事务日志，感知整个分布式事务状态来决定整个事务是COMMIT和ROLLBACK。
        2.参与者：参与者是分布式事务中的一个原子单位，所有参与者都必须在一阶段接口(Prepare)中标注(Annotation)参与者的标识，它定义了prepare,commit,rollback3个基本接口，业务系统需要实现这3个接口，并保证其业务数据的冥等行。必须保证prepare中的数据操作能够被提交(COMMIT)或者回滚(ROLLBACK).从存储结构上，DTS的事务状态数据可以分为主事务状态(Acitivity)和分支事务记录(Action)俩类：
        3.主事务记录Activity：主事务记录是整个分布式事务的主体、其最核心的数据结构是事务号(TX_ID)和事务状态(STATE),它是在启动分布式事务的时候持久化写入数据库的，它的状态决定了这笔分布式事务的状态。
        4.分支事务记录Action:分支事务记录是主事务记录的一个子集，它记录了一个参与者的信息，其中包括参与者的NAME名称，DTS通过这个NAME来唯一定位一个参与者。通过这个分支事务信息，我们可以就可以对参与和进行提交或者回滚操作。